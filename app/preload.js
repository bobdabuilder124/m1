"use strict";
var q=Object.create;var T=Object.defineProperty;var F=Object.getOwnPropertyDescriptor;var W=Object.getOwnPropertyNames;var K=Object.getPrototypeOf,U=Object.prototype.hasOwnProperty;var X=(e,n)=>{for(var s in n)T(e,s,{get:n[s],enumerable:!0})},B=(e,n,s,a)=>{if(n&&typeof n=="object"||typeof n=="function")for(let t of W(n))!U.call(e,t)&&t!==s&&T(e,t,{get:()=>n[t],enumerable:!(a=F(n,t))||a.enumerable});return e};var A=(e,n,s)=>(s=e!=null?q(K(e)):{},B(n||!e||!e.__esModule?T(s,"default",{value:e,enumerable:!0}):s,e)),Y=e=>B(T({},"__esModule",{value:!0}),e);var V={};X(V,{getTimezoneByRegionKey:()=>z,regionMappings:()=>O,strippedConsole:()=>w,styleSettingsCSS:()=>y});module.exports=Y(V);var g=require("fs"),m=require("path"),r=require("electron"),$=require("./matchmaker"),o=require("./utils"),R=require("./settingsui"),_=require("compare-versions"),x=A(require("dayjs")),D=A(require("dayjs/plugin/utc"));x.default.extend(D.default),window.OffCliV=!0,window.addEventListener("mousedown",e=>{console.log("Mouse Down at:",e.clientX,e.clientY)}),window.addEventListener("mouseup",e=>{console.log("Mouse Up at:",e.clientX,e.clientY)}),window.addEventListener("mousemove",e=>{console.log("Mouse moved to:",e.clientX,e.clientY)});const w={error:console.error.bind(console),log:console.log.bind(console),warn:console.warn.bind(console),time:console.time.bind(console),timeEnd:console.timeEnd.bind(console)},v=(0,m.resolve)(__dirname,"..","assets"),y={hideAds:(0,g.readFileSync)((0,m.join)(v,"hideAds.css"),{encoding:"utf-8"}),menuTimer:(0,g.readFileSync)((0,m.join)(v,"menuTimer.css"),{encoding:"utf-8"}),quickClassPicker:(0,g.readFileSync)((0,m.join)(v,"quickClassPicker.css"),{encoding:"utf-8"})+(0,o.hiddenClassesImages)(16),hideReCaptcha:"body > div:not([class]):not([id]) > div:not(:empty):not([class]):not([id]) { display: none; }"};r.ipcRenderer.on("main_did-finish-load",(e,n)=>G(n)),r.ipcRenderer.on("checkForUpdates",async(e,n)=>{const t=(await(await fetch(`https://api.github.com/repos/${o.repoID}/releases/latest`)).json()).tag_name,l=(0,_.compareVersions)(n,t),i=(0,o.createElement)("div",{class:["crankshaft-holder-update","refresh-popup"],id:"#loadInfoUpdateHolder"});if(l===-1){i.appendChild((0,o.createElement)("a",{text:`New update! Download ${t}`}));const b=()=>{r.ipcRenderer.send("openExternal",`https://github.com/${o.repoID}/releases/latest`)};try{i.removeEventListener("click",b)}catch{}i.addEventListener("click",b)}else i.appendChild((0,o.createElement)("span",{text:"No new updates"}));w.log(`Crankshaft client v${n} latest: v${t}`),document.body.appendChild(i);let u=setTimeout(()=>i.remove(),5e3);i.onmouseenter=()=>clearTimeout(u),i.onmouseleave=()=>{u=setTimeout(()=>i.remove(),5e3)},document.addEventListener("pointerlockchange",()=>{clearTimeout(u),i.remove()},{once:!0})}),r.ipcRenderer.on("initDiscordRPC",()=>{function e(){w.log("> updated RPC");const n=document.getElementById("menuClassName"),s=document.querySelector("#menuClassSubtext > span"),a=document.getElementById("mapInfo"),t=(0,o.hasOwn)(window,"getGameActivity")?window.getGameActivity():{};let l=!1;(0,o.hasOwn)(t,"class")||(t.class={name:n?.textContent??""}),(!(0,o.hasOwn)(t,"map")||!(0,o.hasOwn)(t,"mode"))&&(l=a?.textContent??"Loading game...");const i={details:l||`${t.mode} on ${t.map}`,state:`${t.class.name} \u2022 ${s===null?"":s.textContent}`};s?r.ipcRenderer.send("preload_updates_DiscordRPC",i):r.ipcRenderer.send("preload_updates_DiscordRPC",{details:"Loading krunker...",state:"github.com/KraXen72/crankshaft"})}r.ipcRenderer.on("main_did-finish-load",e),window.addEventListener("load",()=>{e(),setTimeout(()=>{try{document.getElementById("windowCloser").addEventListener("click",e)}catch(n){w.error("didn't hook wincloser",n)}try{document.getElementById("customizeButton").addEventListener("click",e)}catch(n){w.error("didn't hook customizeButton",n)}},4e3)}),document.addEventListener("pointerlockchange",e)}),r.ipcRenderer.on("matchmakerRedirect",(e,n)=>(0,$.fetchGame)(n)),r.ipcRenderer.on("injectClientCSS",(e,n,s)=>{const{matchmaker:a,matchmaker_F6:t}=n;document.addEventListener("keydown",f=>{f.code==="Escape"&&document.exitPointerLock(),f.code==="F1"&&a&&!t&&r.ipcRenderer.send("matchmaker_requests_userPrefs")});const{hideAds:l,menuTimer:i,quickClassPicker:u,hideReCaptcha:b,clientSplash:S,userscripts:L}=n,d="Crankshaft-splash-css",c="Crankshaft-settings-css",p=(0,g.readFileSync)((0,m.join)(v,"settingCss.css"),{encoding:"utf-8"});if((0,o.injectSettingsCSS)(p,c),S){const f=(0,g.readFileSync)((0,m.join)(v,"splashCss.css"),{encoding:"utf-8"});(0,o.injectSettingsCSS)(f,d);const C=document.getElementById("instructionHider");if(C===null)throw"Krunker didn't create #instructionHider";const k=(0,o.createElement)("svg",{id:"crankshaft-logo-holder",innerHTML:(0,g.readFileSync)((0,m.join)(v,"full_logo.svg"),{encoding:"utf-8"})}),h=I=>{try{k.remove(),I.disconnect()}catch{console.log("splash screen was already cleared.")}};C.appendChild(k),k.appendChild((0,o.createElement)("div",{class:"crankshaft-holder-l",id:"#loadInfoLHolder",text:`v${s}`})),k.appendChild((0,o.createElement)("div",{class:"crankshaft-holder-r",id:"#loadInfoRHolder",text:"by KraXen72 and contributors"}));const E={attributes:!0,childList:!0,subtree:!0},N=(I,M)=>{for(const j of I)j.type==="childList"&&h(M)},H=new MutationObserver(N);H.observe(document.getElementById("instructions"),E),document.addEventListener("pointerlockchange",()=>{h(H)},{once:!0})}(l==="block"||l==="hide")&&((0,o.toggleSettingCSS)(y.hideAds,"hideAds",!0),document.getElementById("hiddenClasses").classList.add("hiddenClasses-hideAds-bottomOffset")),i&&(0,o.toggleSettingCSS)(y.menuTimer,"menuTimer",!0),u&&(0,o.toggleSettingCSS)(y.quickClassPicker,"quickClassPicker",!0),b&&(0,o.toggleSettingCSS)(y.hideReCaptcha,"hideReCaptcha",!0),L&&r.ipcRenderer.send("initializeUserscripts")});const O=[{name:"Frankfurt",id:"de-fra",code:"FRA",offset:2},{name:"Silicon Valley",id:"us-ca-sv",code:"SV",offset:-7},{name:"Sydney",id:"au-syd",code:"SYD",offset:10},{name:"Tokyo",id:"jb-hnd",code:"TOK",offset:9},{name:"Miami",id:"us-fl",code:"MIA",offset:-4},{name:"Singapore",id:"sgp",code:"SIN",offset:8},{name:"New York",id:"us-nj",code:"NY",offset:-4},{name:"Mumbai",id:"as-mb",code:"MBI",offset:5.5},{name:"Dallas",id:"us-tx",code:"DAL",offset:-5},{name:"Brazil",id:"brz",code:"BRZ",offset:-3},{name:"Middle East",id:"me-bhn",code:"BHN",offset:3},{name:"South Africa",id:"af-ct",code:"AFR",offset:2},{name:"China (hidden)",id:"",code:"CHI",offset:8},{name:"London (hidden)",id:"",code:"LON",offset:1},{name:"Seattle (hidden)",id:"",code:"STL",offset:-7},{name:"Mexico (hidden)",id:"",code:"MX",offset:-6}],P=new RegExp("s*<option value=.*(de-fra).*(us-ca-sv).*</option>","gu");function z(e,n){if(e==="id"&&n==="")throw new Error("getTimezoneByRegionKey: forbidden to get regions by id with empty id, would match multiple hidden regions");const s=(0,x.default)().utc(),a=O.filter(i=>i[e]===n);if(a.length===0)throw new Error(`getTimezoneByRegionKey: couldn't get region object for '${e}' === '${n}'`);const t=a[0];return`[${(t.offset>0?s.add(t.offset,"hour"):s.subtract(Math.abs(t.offset),"hour")).format("HH:mm")}]`}function G(e){let n=null;w.log("waiting to hook settings...");function s(){const t=window.windows[0];let l=t.tabIndex;function i(){const d=t.tabs[t.settingType].length-1;return l===d}function u(){const d=document.getElementById("settHolder");!i()&&d!==null&&d.classList.remove("Crankshaft-settings"),i()&&(0,R.renderSettings)()}const b=window.showWindow.bind(window),S=t.getSettings.bind(t),L=t.changeTab.bind(t);window.showWindow=(...d)=>{const c=b(...d);if(d[0]===1){t.settingType==="basic"&&t.toggleType({checked:!0});const p=document.querySelector(".advancedSwitch input#typeBtn");p.disabled=!0,p.nextElementSibling.setAttribute("title","Crankshaft auto-enables advanced settings mode"),i()&&(0,R.renderSettings)()}return c},t.changeTab=(...d)=>{const c=L(...d);return l=t.tabIndex,u(),c},t.getSettings=(...d)=>{const c=S(...d);if(!e.regionTimezones)return c;if(c.includes('window.setSetting("defaultRegion"')&&c.match(P).length>0){const p=c.match(P)[0],f=[...(0,o.createElement)("div",{innerHTML:p}).children];for(let h=0;h<f.length;h++){const E=f[h];E.textContent+=` ${z("id",E.value)}`}const C=document.createElement("div");f.forEach(h=>C.appendChild(h));const k=C.innerHTML;return c.replace(p,k)}return c},u()}function a(){(0,o.hasOwn)(window,"showWindow")&&typeof window.showWindow=="function"&&(0,o.hasOwn)(window,"windows")&&Array.isArray(window.windows)&&window.windows.length>=0&&typeof window.windows[0]<"u"&&typeof window.windows[0].changeTab=="function"&&(clearInterval(n),w.log("hooking settings"),s())}n=setInterval(a,250)}0&&(module.exports={getTimezoneByRegionKey,regionMappings,strippedConsole,styleSettingsCSS});

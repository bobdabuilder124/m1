"use strict";
var O=Object.create;var v=Object.defineProperty;var L=Object.getOwnPropertyDescriptor;var B=Object.getOwnPropertyNames;var E=Object.getPrototypeOf,j=Object.prototype.hasOwnProperty;var z=(i,l,u,a)=>{if(l&&typeof l=="object"||typeof l=="function")for(let r of B(l))!j.call(i,r)&&r!==u&&v(i,r,{get:()=>l[r],enumerable:!(a=L(l,r))||a.enumerable});return i};var H=(i,l,u)=>(u=i!=null?O(E(i)):{},z(l||!i||!i.__esModule?v(u,"default",{value:i,enumerable:!0}):u,i));var c=require("path"),n=require("fs"),I=require("./utils_node"),e=require("electron"),d=require("./menu"),T=require("./switches"),G=H(require("./requesthandler"));const p=(0,c.join)(e.app.getPath("userData"),"config"),g=(0,c.join)(e.app.getPath("documents"),"Crankshaft"),h=p;function J(){if(!((0,n.existsSync)((0,c.join)(g,"settings moved.txt"))||(0,n.readdirSync)(g).length===0)){if((0,n.existsSync)(p)||(0,n.mkdirSync)(p),console.log(`Migrating old settings to new path ${p}`),(0,n.existsSync)(p)&&(0,n.readdirSync)(p).length!==0){const i=new Error(`Cannot migrate settings!

		From (old folder): ${g}
		To (new folder): ${p}

		There are files in both directories!
		Make sure your actual settings, swapper & scripts are in the new folder & delete stuff from the old one.
		
		Crankshaft v${e.app.getVersion()} no longer supports settings in Documents due to inconsistent permissions.
		
		Restart crankshaft afterwards.`);throw i.stack=null,i}(0,I.moveFolderSync)(g,p),(0,n.existsSync)(g)||(0,n.mkdirSync)(g),(0,n.writeFileSync)((0,c.join)(g,"settings moved.txt"),`Starting from crankshaft v1.9.0, the configuration directory is no longer '${g}'.

Settings, userscripts and swapper have been moved to '${p}'.

You can verify that they are indeed there, and then safely delete this directory.`)}}const P=(0,c.join)(h,"swapper"),C=(0,c.join)(h,"settings.json"),S=(0,c.join)(h,"/userscriptsettings"),F=(0,c.join)(h,"filters.txt"),y=(0,c.join)(h,"scripts"),A=(0,c.join)(y,"tracker.json");e.app.userAgentFallback="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Electron/10.4.7 Safari/537.36";const D={fpsUncap:!0,inProcessGPU:!1,disableAccelerated2D:!1,hideReCaptcha:!0,menuTimer:!1,quickClassPicker:!1,fullscreen:"windowed",resourceSwapper:!0,userscripts:!1,clientSplash:!0,discordRPC:!1,extendedRPC:!0,"angle-backend":"default",logDebugToConsole:!1,alwaysWaitForDevTools:!1,safeFlags_removeUselessFeatures:!0,safeFlags_helpfulFlags:!0,safeFlags_gpuRasterizing:!1,experimentalFlags_increaseLimits:!1,experimentalFlags_lowLatency:!1,experimentalFlags_experimental:!1,matchmaker:!1,matchmaker_F6:!1,matchmaker_regions:[],matchmaker_gamemodes:[],matchmaker_minPlayers:1,matchmaker_maxPlayers:6,matchmaker_minRemainingTime:120,hideAds:"hide",customFilters:!1,regionTimezones:!1},t=D;(0,n.existsSync)(h)||(0,n.mkdirSync)(h,{recursive:!0}),(0,n.existsSync)(C)||(0,n.writeFileSync)(C,JSON.stringify(D,null,2),{encoding:"utf-8",flag:"wx"}),(0,n.existsSync)(S)||(0,n.mkdirSync)(S,{recursive:!0}),(0,n.existsSync)(P)||(0,n.mkdirSync)(P,{recursive:!0}),(0,n.existsSync)(y)||(0,n.mkdirSync)(y,{recursive:!0}),(0,n.existsSync)(A)||(0,n.writeFileSync)(A,"{}",{encoding:"utf-8"}),(0,n.existsSync)(F)||(0,n.writeFileSync)(F,`# Welcome to the filters file! Filters follow the URL pattern format:
# https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/Match_patterns
# Hashtags are used for comments, and each line is a new filter.
# Here's an example of a filter that blocks the cosmetic bundle popup audio:
# *://assets.krunker.io/sound/bundle_*.mp3*
`),Object.assign(t,JSON.parse((0,n.readFileSync)(C,{encoding:"utf-8"})));let _=!1;typeof t.fullscreen=="boolean"&&(_=!0,t.fullscreen===!0?t.fullscreen="fullscreen":t.fullscreen="windowed"),typeof t.hideAds=="boolean"&&(_=!0,t.hideAds===!0?t.hideAds="hide":t.hideAds="off"),_&&(0,n.writeFileSync)(C,JSON.stringify(t,null,2),{encoding:"utf-8"});let s,m;e.ipcMain.on("logMainConsole",(i,l)=>{console.log(l)}),e.ipcMain.on("initializeUserscripts",()=>{s.webContents.send("main_initializes_userscripts",{userscriptsPath:y,userscriptPrefsPath:S},__dirname)}),e.ipcMain.on("settingsUI_requests_userPrefs",()=>{const i={settingsPath:C,swapperPath:P,filtersPath:F,userscriptPreferencesPath:S,configPath:h,userscriptsPath:y};s.webContents.send("m_userPrefs_for_settingsUI",i,t)}),e.ipcMain.on("matchmaker_requests_userPrefs",()=>{s.webContents.send("matchmakerRedirect",t)}),e.ipcMain.on("settingsUI_updates_userPrefs",(i,l)=>{Object.assign(t,l)}),e.ipcMain.on("openExternal",(i,l)=>{e.shell.openExternal(l)});const x=(0,c.resolve)(__dirname,"..","assets"),W=(0,n.readFileSync)((0,c.join)(x,"hideAds.css"),{encoding:"utf-8"});function U(i,l,u=!0){const a=new e.BrowserWindow({autoHideMenuBar:!0,show:!1,width:1600,height:900,center:!0,webPreferences:{spellcheck:!1,enableRemoteModule:!1,nodeIntegration:!1}}),r=process.platform==="darwin"?1:0,{submenu:o}=l[r];u&&Array.isArray(o)&&(l[r].submenu=o.concat([{label:"Copy current url to clipboard",accelerator:"F7",click:()=>{e.clipboard.writeText(a.webContents.getURL())}},{label:"Debug: Display original url",accelerator:"CommandOrControl+F1",click:()=>{e.dialog.showMessageBoxSync(a,{message:i})}},{type:"separator"},{label:"Go to previous page (Go Back)",registerAccelerator:!1,click:()=>{a.webContents.canGoBack()&&a.webContents.goBack()}},{label:"Go to next page (Go Forward)",registerAccelerator:!1,click:()=>{a.webContents.canGoForward()&&a.webContents.goForward()}},{type:"separator"},...(0,d.constructDevtoolsSubmenu)(a,t.alwaysWaitForDevTools||null)]));const b=e.Menu.buildFromTemplate(l);return a.setMenu(b),a.setMenuBarVisibility(!1),a.loadURL(i),a.once("ready-to-show",()=>{(t.hideAds==="hide"||t.hideAds==="block")&&a.webContents.insertCSS(W),a.show()}),(t.hideAds==="hide"||t.hideAds==="block")&&a.webContents.on("did-navigate",()=>{a.webContents.insertCSS(W)}),a.once("close",()=>{a.destroy()}),a}(0,T.applyCommandLineSwitches)(t),t.resourceSwapper&&e.protocol.registerSchemesAsPrivileged([{scheme:"krunker-resource-swapper",privileges:{secure:!0,corsEnabled:!0,bypassCSP:!0}}]),e.app.on("ready",()=>{e.app.setAppUserModelId(process.execPath),t.resourceSwapper&&e.protocol.registerFileProtocol("krunker-resource-swapper",(r,o)=>o(decodeURI(r.url.replace(/krunker-resource-swapper:/u,""))));const i={show:!1,width:1600,height:900,center:!0,webPreferences:{preload:(0,c.join)(__dirname,"preload.js"),enableRemoteModule:!1,spellcheck:!1,nodeIntegration:!1},backgroundColor:"#000000"};switch(t.fullscreen){case"fullscreen":i.fullscreen=!0;break;case"borderless":{const r=e.screen.getPrimaryDisplay().bounds,o={frame:!1,kiosk:!0,fullscreenable:!1,fullscreen:!1,width:r.width,height:r.height};Object.assign(i,o);break}case"windowed":default:i.fullscreen=!1;break}s=new e.BrowserWindow(i),t.fullscreen==="borderless"&&s.moveTop(),s.on("ready-to-show",()=>{if(t.fullscreen==="maximized"&&!s.isMaximized()&&s.maximize(),s.isVisible()||s.show(),t.fullscreen==="fullscreen"&&s.setFullScreen(!0),s.webContents.getURL().endsWith("dummy.html")){s.loadURL("https://krunker.io");return}if(s.webContents.send("injectClientCSS",t,e.app.getVersion()),t.discordRPC){let k=function({details:w,state:R}){const M={details:w,state:R,startTimestamp:b,largeImageKey:"logo",largeImageText:"Playing Krunker",instance:!0};t.extendedRPC&&Object.assign(M,{buttons:[{label:"Github",url:"https://github.com/KraXen72/crankshaft"},{label:"Discord Server",url:"https://discord.gg/ZeVuxG7gQJ"}]}),o.setActivity(M)};const r=require("discord-rpc"),o=new r.Client({transport:"ipc"}),b=new Date;o.login({clientId:"988529967220523068"}).catch(console.error),s.webContents.send("initDiscordRPC"),e.ipcMain.on("preload_updates_DiscordRPC",(w,R)=>{k(R)})}}),s.once("ready-to-show",()=>{s.webContents.send("checkForUpdates",e.app.getVersion()),s.webContents.on("did-finish-load",()=>s.webContents.send("main_did-finish-load",t))}),s.loadFile((0,c.join)(x,"dummy.html")),t.logDebugToConsole&&(console.log("GPU INFO BEGIN"),e.app.getGPUInfo("complete").then(r=>{console.dir(r)}),console.log("GPU FEATURES BEGIN"),console.dir(e.app.getGPUFeatureStatus()));const l={label:"Game",submenu:[{label:"Reload this game",accelerator:"F5",click:()=>{s.reload()}},{label:"Find new Lobby",accelerator:"F6",click:()=>{t.matchmaker&&t.matchmaker_F6?s.webContents.send("matchmakerRedirect",t):s.loadURL("https://krunker.io")}},{label:"Copy game link to clipboard",accelerator:"F7",click:()=>{e.clipboard.writeText(s.webContents.getURL())}},{label:"Join game link from clipboard",accelerator:"CommandOrControl+F7",click:()=>{const r=e.clipboard.readText();r.includes("https://krunker.io/?game")&&s.webContents.loadURL(r)}},{type:"separator"},...(0,d.constructDevtoolsSubmenu)(s,t.alwaysWaitForDevTools||null)]};process.platform!=="darwin"&&d.csMenuTemplate.push({label:"About",submenu:d.aboutSubmenu});const u=e.Menu.buildFromTemplate([...d.macAppMenuArr,l,...d.csMenuTemplate]),a=[...d.macAppMenuArr,d.genericMainSubmenu,...d.csMenuTemplate];e.Menu.setApplicationMenu(u),s.setMenu(u),s.setAutoHideMenuBar(!0),s.setMenuBarVisibility(!1),s.webContents.on("new-window",(r,o)=>{console.log("url trying to open:",o,"socialWindowReference:",typeof m);const b=["youtube.com","twitch.tv","twitter.com","reddit.com","discord.com","accounts.google.com","instagram.com","github.com"];if(typeof m<"u"&&m.isDestroyed()&&(m=void 0),o.includes("https://krunker.io/social.html")&&typeof m<"u")r.preventDefault(),m.loadURL(o);else if(b.some(f=>o.includes(f)))switch(e.dialog.showMessageBoxSync({title:"Opening a new url",noLink:!1,message:`You're trying to open ${o}`,buttons:["Open in default browser","Open as a new window in client","Open in this window","Don't open"]})){case 0:r.preventDefault(),e.shell.openExternal(o);break;case 2:r.preventDefault(),s.loadURL(o);break;case 3:r.preventDefault();break;case 1:default:{r.preventDefault();const k=U(o,a);r.newGuest=k;break}}else if(o.includes("comp.krunker.io")||o.startsWith("https://krunker.io/?game")||o.startsWith("https://krunker.io/?play")||o.includes("?game=")&&o.includes("&matchId="))r.preventDefault(),s.loadURL(o);else{r.preventDefault(),console.log(`genericWindow created for ${o}`,m);const f=U(o,a);r.newGuest=f,o.includes("https://krunker.io/social.html")&&(m=f,f.on("close",()=>{m=void 0}),f.webContents.on("will-navigate",(k,w)=>{w.includes("https://krunker.io/social.html")?f.loadURL(w):(k.preventDefault(),e.shell.openExternal(w))}))}}),(t.resourceSwapper||t.hideAds==="block")&&new G.default(s,P,t.resourceSwapper,t.hideAds==="block",t.customFilters,(0,n.readFileSync)((0,c.join)(x,"blockFilters.txt")).toString(),F).start()}),e.app.on("window-all-closed",()=>{if(process.platform!=="darwin")return e.app.quit()});
